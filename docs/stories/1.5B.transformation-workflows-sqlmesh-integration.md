# Story 1.5B: Transformation Workflows - SQLmesh Integration

## Status
Draft

## Story
**As a** data engineer,
**I want** to define and execute transformation workflows using SQLmesh with cost optimization and blue-green deployment,
**so that** I can reduce warehouse costs and deploy models safely without errors.

## Acceptance Criteria
1. Integrate SQLmesh with Python subprocess execution and auto-detection
2. Create SQLmesh project structure within expansion pack (/sqlmesh-project/)
3. Implement embedded documentation and model configuration patterns
4. Configure cost optimization and blue-green deployment capabilities
5. Enable Python model support alongside SQL models
6. Integrate with existing security framework (API keys, feature flags, logging)
7. Implement auto-detection logic for transformation engine selection
8. Create transformation engine abstraction for dual-tool support

## Integration Verification
- IV1: Existing dbt functionality remains unchanged and available
- IV2: Auto-detection correctly identifies available transformation engines
- IV3: SQLmesh operations don't interfere with existing dbt or BMad processes
- IV4: Feature flag 'sqlmesh_transformations' controls SQLmesh availability
- IV5: Cost optimization features demonstrate measurable warehouse savings
- IV6: Blue-green deployment capabilities prevent production errors
- IV7: DuckDB integration works seamlessly with SQLmesh transformations
- IV8: Both transformation engines can coexist and be user-selectable

## Tasks / Subtasks

- [ ] Task 1: Install and configure SQLmesh environment (AC: 1)
  - [ ] Add SQLmesh ^0.25.0 to requirements.txt with DuckDB adapter
  - [ ] Create Python subprocess wrapper for SQLmesh command execution
  - [ ] Configure SQLmesh project structure within expansion pack
  - [ ] Create SQLmesh config.yaml configuration for DuckDB connection
  - [ ] Implement SQLmesh command execution with proper error handling
  - [ ] Test SQLmesh installation and basic model compilation

- [ ] Task 2: Create enhanced TransformationEngine component (AC: 1, 6, 7, 8)
  - [ ] Extend `tools/data-services/transformation-engine.js` with auto-detection
  - [ ] Implement SQLmesh project initialization and model execution
  - [ ] Add SQLmesh subprocess execution with JSON communication
  - [ ] Create SQLmesh command wrapper functions (plan, run, test, audit)
  - [ ] Implement transformation engine abstraction layer
  - [ ] Add auto-detection logic for available transformation tools
  - [ ] Integrate authentication middleware for SQLmesh endpoints
  - [ ] Add feature flag checking for 'sqlmesh_transformations' before operations
  - [ ] Implement security logging for all SQLmesh operations

- [ ] Task 3: Implement SQLmesh project initialization (AC: 2)
  - [ ] Create automated SQLmesh project setup within bmad-data-practitioner
  - [ ] Generate config.yaml with proper DuckDB configuration
  - [ ] Create standard directory structure (models/, audits/, seeds/, macros/, tests/)
  - [ ] Add DuckDB-specific SQLmesh adapter configuration
  - [ ] Implement project validation and setup verification
  - [ ] Create project templates for different analysis types

- [ ] Task 4: Configure cost optimization and blue-green deployment (AC: 4, 6)
  - [ ] Implement SQLmesh virtual data environments
  - [ ] Configure intelligent execution strategies for cost optimization
  - [ ] Enable blue-green deployment patterns with rollback capabilities
  - [ ] Add cost monitoring and optimization reporting
  - [ ] Implement deployment safety checks and validation
  - [ ] Create deployment workflow templates

- [ ] Task 5: Enable embedded documentation and Python models (AC: 3, 5)
  - [ ] Configure SQLmesh embedded documentation patterns
  - [ ] Implement SQL + Python model coordination
  - [ ] Create documentation generation workflows
  - [ ] Add model description and metadata standards
  - [ ] Integrate with BMad documentation patterns
  - [ ] Configure lineage and dependency visualization

- [ ] Task 6: Integration testing and validation (All IVs)
  - [ ] Verify existing dbt functionality remains unchanged (IV1)
  - [ ] Test auto-detection logic for transformation engines (IV2)
  - [ ] Test SQLmesh operations isolation from BMad build processes (IV3)
  - [ ] Validate feature flag controls SQLmesh availability (IV4)
  - [ ] Demonstrate cost optimization measurable benefits (IV5)
  - [ ] Verify blue-green deployment prevents production errors (IV6)
  - [ ] Test DuckDB integration for SQLmesh data sources (IV7)
  - [ ] Validate dual-engine coexistence and user selection (IV8)
  - [ ] Run regression tests on existing BMad functionality
  - [ ] Performance testing for SQLmesh transformation workflows

## Dev Notes

### SQLmesh Technology Overview
SQLmesh is a data transformation framework that addresses legacy tool limitations through:
- **Cost Optimization**: Intelligent execution reduces warehouse costs through virtual environments
- **Blue-Green Deployment**: Safe model deployment with automatic rollback capabilities
- **Embedded Documentation**: Documentation and configuration within SQL files, reducing YAML overhead
- **Python + SQL Support**: Native support for both SQL and Python models in single framework
- **Automatic Dependencies**: Dependency detection without manual specification

### Integration Architecture
**Dual-Engine Strategy**: Both dbt and SQLmesh will coexist with auto-detection logic:
- Auto-detection checks for SQLmesh project first, falls back to dbt
- Feature flags control availability of each engine
- User can override auto-detection with explicit configuration
- Transformation engine abstraction enables seamless switching

**SQLmesh Project Structure**:
```
bmad-data-practitioner/sqlmesh-project/
├── config.yaml                    # SQLmesh configuration
├── models/                        # SQL and Python models
│   ├── staging/
│   ├── intermediate/
│   └── marts/
├── audits/                        # Data quality audits
├── seeds/                         # Static data files
├── macros/                        # Reusable functions
└── tests/                         # Model tests
```

**Cost Optimization Features**:
- Virtual data environments prevent unnecessary warehouse usage
- Intelligent execution strategies minimize compute costs
- Blue-green deployment eliminates production errors and rollback costs
- Embedded documentation reduces maintenance overhead

### Security Integration
Following Story 1.1.5 security framework:
- API key authentication for all SQLmesh transformation endpoints
- Feature flag 'sqlmesh_transformations' controls service availability
- Security logging for all SQLmesh operations with sensitive data filtering
- Integration with existing security patterns and validation

### Testing Standards
Following existing BMad testing patterns:
- **Test Location**: `/tests/data-services/sqlmesh-*.test.js`
- **Coverage Target**: 80% minimum for all SQLmesh components
- **Integration Tests**: SQLmesh + DuckDB + security framework validation
- **Performance Tests**: Cost optimization validation and deployment speed

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-17 | 1.0 | Initial story creation for SQLmesh integration | PO Sarah |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*This section will be populated by the QA agent after story completion*